import{_ as re,u as te,z as oe,r as b,Z as K,o as le,O as P,P as d,b as ne,f as a,w as s,i as I,e as y,h as _,N as q,Q as de,y as ie}from"./index-6DHakvZj.js";import{v as O}from"./privacy-F99ZVvUi.js";const ue={class:"personal-center"},ce={class:"avatar-upload"},pe={class:"dialog-footer"},fe={class:"dialog-footer"},me={__name:"PersonalCenter",setup(we){const V=te(),p=oe(),E=b(null),L=b(null),h=b(!1),B=b(""),z=b(!1),A=b(!1),D=b(!1),R=b("");let x=null;const m=K({username:"",email:"",avatar:""}),f=K({oldPassword:"",newPassword:"",confirmPassword:""});le(async()=>{if(V.userInfo)m.username=V.userInfo.username,m.email=V.userInfo.email,m.avatar=V.userInfo.avatar||"";else try{const r=await P.get("/users/profile");m.username=r.username,m.email=r.email,m.avatar=r.avatar||"",V.setUserInfo(r)}catch(r){console.error("获取用户信息失败:",r),d.error("获取用户信息失败")}});const Q=()=>{E.value.click()},W=async r=>{var n,i;const e=r.target.files[0];if(!e)return;if(e.size>2*1024*1024){d.error("头像文件大小不能超过 2MB");return}if(!["image/png","image/jpeg","image/jpg","image/gif","image/webp"].includes(e.type)){d.error("仅支持 PNG、JPG、GIF、WEBP 格式的图片");return}try{const t=new FormData;t.append("file",e);const g=await P.post("/users/avatar",t,{headers:{"Content-Type":"multipart/form-data"}});m.avatar=g.avatar_url,V.setUserInfo({...V.userInfo,avatar:g.avatar_url}),d.success("头像上传成功")}catch(t){d.error("头像上传失败: "+(((i=(n=t.response)==null?void 0:n.data)==null?void 0:i.msg)||t.message))}},Z=async()=>{var r,e;try{const l=await P.put("/users/profile",{username:m.username,avatar:m.avatar});V.setUserInfo(l.user),d.success("个人信息更新成功")}catch(l){d.error("更新失败: "+(((e=(r=l.response)==null?void 0:r.data)==null?void 0:e.msg)||l.message))}},H=async()=>{var r,e;if(!f.oldPassword||!f.newPassword||!f.confirmPassword){d.warning("请填写所有密码字段");return}if(f.newPassword!==f.confirmPassword){d.warning("两次输入的新密码不一致");return}if(f.newPassword.length<6){d.warning("新密码长度不能少于6位");return}try{await P.put("/users/password",{old_password:f.oldPassword,new_password:f.newPassword}),d.success("密码修改成功，请重新登录"),f.oldPassword="",f.newPassword="",f.confirmPassword=""}catch(l){d.error("修改失败: "+(((e=(r=l.response)==null?void 0:r.data)==null?void 0:e.msg)||l.message))}},X=async()=>{if(!p.password){B.value="",h.value=!0;return}N(!0)},G=async()=>{var r,e;if(!B.value){d.warning("请输入隐私空间密码或选择跳过");return}try{const{access_token:l}=await O(B.value);p.setAccessToken(l),p.setPassword(B.value),h.value=!1,N(!0)}catch(l){d.error(((e=(r=l.response)==null?void 0:r.data)==null?void 0:e.msg)||"隐私空间密码验证失败")}},Y=()=>{h.value=!1,N(!1)},N=async(r=!0)=>{var e,l;try{z.value=!0;const n=async(u=!1)=>{if(u&&!r)return[];const c={sort_by:"updated_at",order:"desc"};if(u){if(c.privacy_space=!0,p.password)c._privacy_password=p.password;else return d.warning("缺少隐私空间密码，跳过隐私文档备份"),[];if(!p.accessToken||p.needsReauth())return d.warning("隐私空间访问已过期，请先在文档页重新验证后再备份"),[]}const k=await P.get("/docs/",{params:c});return(await Promise.all(k.map(async w=>{try{const U={};return u&&p.password&&(U._privacy_password=p.password),await P.get(`/docs/${w.id}`,{params:U})}catch(U){return console.error("备份文档详情失败:",U),null}}))).filter(Boolean)},i=async(u=!1)=>{const c={in_privacy_space:u};return await P.get("/docs/folders",{params:c})},[t,g,C,T]=await Promise.all([n(!1),n(!0),i(!1),i(!0)]),o={userInfo:V.userInfo,preferences:{theme:localStorage.getItem("theme")||"light"},folders:[...C.map(u=>({id:u.id,name:u.name,order:u.order,in_privacy_space:!1})),...T.map(u=>({id:u.id,name:u.name,order:u.order,in_privacy_space:!0}))],documents:{public:t,privacy:g},timestamp:new Date().toISOString()},S=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),F=URL.createObjectURL(S),v=document.createElement("a");v.href=F,v.download=`backup_${new Date().getTime()}.json`,v.click(),URL.revokeObjectURL(F),d.success("备份导出成功")}catch(n){d.error("备份失败: "+(((l=(e=n.response)==null?void 0:e.data)==null?void 0:l.msg)||n.message))}finally{z.value=!1}},ee=()=>{L.value.click()},ae=async r=>{const e=r.target.files[0];if(e)try{await de.confirm("恢复数据将覆盖当前设置和数据，是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const l=new FileReader;l.onload=async n=>{var i;try{const t=JSON.parse(n.target.result);x=t,Array.isArray((i=t==null?void 0:t.documents)==null?void 0:i.privacy)&&t.documents.privacy.length>0&&!p.password?(R.value="",D.value=!0):await $(t,!0)}catch{d.error("备份文件格式错误")}},l.readAsText(e)}catch{}},J=async()=>{var r,e;if(!R.value){d.warning("请输入隐私空间密码或选择跳过");return}try{const{access_token:l}=await O(R.value);p.setAccessToken(l),p.setPassword(R.value),D.value=!1,x&&(await $(x,!0),x=null)}catch(l){d.error(((e=(r=l.response)==null?void 0:r.data)==null?void 0:e.msg)||"隐私空间密码验证失败")}},se=async()=>{D.value=!1,x&&(await $(x,!1),x=null)},$=async(r,e)=>{var l,n,i;A.value=!0;try{(l=r.preferences)!=null&&l.theme&&localStorage.setItem("theme",r.preferences.theme);const t=r.documents||{},g=r.folders||[],C=t.public||[],T=e?t.privacy||[]:[],o=new Map,S=async(v=!1)=>{const u=await P.get("/docs/folders",{params:{in_privacy_space:v}}),c=new Map(u.map(w=>[`${w.name}_${v}`,w])),k=g.filter(w=>w&&typeof w.name=="string"&&w.in_privacy_space===v);for(const w of k){const U=`${w.name}_${v}`;if(c.has(U))o.set(w.id,c.get(U).id);else try{const M=await P.post("/docs/folders",{name:w.name,in_privacy_space:v});o.set(w.id,M.id)}catch(M){console.error("创建文件夹失败:",M)}}const j=u.find(w=>w.name==="未分组");j&&o.set("uncategorized_"+v,j.id)};await S(!1),await S(!0);const F=async(v,u=!1)=>{if(v.length){if(u){if(!p.password){d.warning("缺少隐私空间密码，已跳过隐私文档恢复");return}if(!p.accessToken||p.needsReauth())try{const{access_token:c}=await O(p.password);p.setAccessToken(c)}catch{d.error("隐私空间验证失败，已跳过隐私文档恢复");return}}for(const c of v)try{let k=null;c.folder_id&&(k=o.get(c.folder_id)||null),!k&&o.has("uncategorized_"+u)&&(k=o.get("uncategorized_"+u)),await P.post("/docs/",{title:c.title,content:c.content,folder_id:k,is_pinned:c.is_pinned||!1,created_at:c.created_at,updated_at:c.updated_at,in_privacy_space:u,_privacy_password:u?p.password:void 0})}catch(k){console.error("恢复文档失败:",k)}}};await F(C,!1),await F(T,!0),d.success("数据恢复完成，文档已导入")}catch(t){d.error("恢复失败: "+(((i=(n=t.response)==null?void 0:n.data)==null?void 0:i.msg)||t.message))}finally{A.value=!1}};return(r,e)=>{const l=I("el-avatar"),n=I("el-button"),i=I("el-form-item"),t=I("el-input"),g=I("el-form"),C=I("el-card"),T=I("el-dialog");return ie(),ne("div",ue,[a(C,{class:"profile-card"},{header:s(()=>[...e[11]||(e[11]=[y("div",{class:"card-header"},[y("span",null,"个人信息")],-1)])]),default:s(()=>[a(g,{model:m,"label-width":"100px"},{default:s(()=>[a(i,{label:"头像"},{default:s(()=>[y("div",ce,[a(l,{size:80,src:m.avatar,icon:"UserFilled"},null,8,["src"]),a(n,{size:"small",onClick:Q,style:{"margin-left":"20px"}},{default:s(()=>[...e[12]||(e[12]=[_("更换头像",-1)])]),_:1}),y("input",{ref_key:"avatarInput",ref:E,type:"file",accept:"image/*",style:{display:"none"},onChange:W},null,544)])]),_:1}),a(i,{label:"用户名"},{default:s(()=>[a(t,{modelValue:m.username,"onUpdate:modelValue":e[0]||(e[0]=o=>m.username=o),placeholder:"请输入用户名",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1}),a(i,{label:"邮箱"},{default:s(()=>[a(t,{modelValue:m.email,"onUpdate:modelValue":e[1]||(e[1]=o=>m.email=o),placeholder:"请输入邮箱",style:{"max-width":"300px"},disabled:""},null,8,["modelValue"])]),_:1}),a(i,null,{default:s(()=>[a(n,{type:"primary",onClick:Z},{default:s(()=>[...e[13]||(e[13]=[_("保存个人信息",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),a(C,{class:"password-card"},{header:s(()=>[...e[14]||(e[14]=[y("div",{class:"card-header"},[y("span",null,"修改密码")],-1)])]),default:s(()=>[a(g,{model:f,"label-width":"100px"},{default:s(()=>[a(i,{label:"当前密码"},{default:s(()=>[a(t,{modelValue:f.oldPassword,"onUpdate:modelValue":e[2]||(e[2]=o=>f.oldPassword=o),type:"password",placeholder:"请输入当前密码",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1}),a(i,{label:"新密码"},{default:s(()=>[a(t,{modelValue:f.newPassword,"onUpdate:modelValue":e[3]||(e[3]=o=>f.newPassword=o),type:"password",placeholder:"请输入新密码",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1}),a(i,{label:"确认密码"},{default:s(()=>[a(t,{modelValue:f.confirmPassword,"onUpdate:modelValue":e[4]||(e[4]=o=>f.confirmPassword=o),type:"password",placeholder:"请再次输入新密码",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1}),a(i,null,{default:s(()=>[a(n,{type:"primary",onClick:H},{default:s(()=>[...e[15]||(e[15]=[_("修改密码",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),a(C,{class:"backup-card"},{header:s(()=>[...e[16]||(e[16]=[y("div",{class:"card-header"},[y("span",null,"备份与恢复")],-1)])]),default:s(()=>[a(g,{"label-width":"120px"},{default:s(()=>[a(i,{label:"备份数据"},{default:s(()=>[a(n,{onClick:X,icon:"Download",loading:z.value},{default:s(()=>[...e[17]||(e[17]=[_("导出备份",-1)])]),_:1},8,["loading"]),e[18]||(e[18]=y("span",{class:"hint"},"备份包括个人偏好设置和文档数据",-1))]),_:1}),a(i,{label:"恢复数据"},{default:s(()=>[a(n,{onClick:ee,icon:"Upload",loading:A.value},{default:s(()=>[...e[19]||(e[19]=[_("选择备份文件",-1)])]),_:1},8,["loading"]),y("input",{ref_key:"restoreInput",ref:L,type:"file",accept:".json",style:{display:"none"},onChange:ae},null,544),e[20]||(e[20]=y("span",{class:"hint"},"从之前的备份文件恢复数据",-1))]),_:1})]),_:1}),a(T,{modelValue:h.value,"onUpdate:modelValue":e[7]||(e[7]=o=>h.value=o),title:"备份隐私空间",width:"420px","close-on-click-modal":!1},{footer:s(()=>[y("span",pe,[a(n,{onClick:e[6]||(e[6]=o=>h.value=!1)},{default:s(()=>[...e[21]||(e[21]=[_("取消",-1)])]),_:1}),a(n,{onClick:Y},{default:s(()=>[...e[22]||(e[22]=[_("跳过隐私文档",-1)])]),_:1}),a(n,{type:"primary",onClick:G},{default:s(()=>[...e[23]||(e[23]=[_("确认并备份",-1)])]),_:1})])]),default:s(()=>[e[24]||(e[24]=y("p",null,"检测到当前会话缺少隐私空间密码，如需同时备份隐私文档请输入密码。",-1)),a(t,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=o=>B.value=o),type:"password",placeholder:"请输入隐私空间密码","show-password":"",onKeyup:q(G,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"]),a(T,{modelValue:D.value,"onUpdate:modelValue":e[10]||(e[10]=o=>D.value=o),title:"恢复隐私空间文档",width:"420px","close-on-click-modal":!1},{footer:s(()=>[y("span",fe,[a(n,{onClick:e[9]||(e[9]=o=>D.value=!1)},{default:s(()=>[...e[25]||(e[25]=[_("取消",-1)])]),_:1}),a(n,{onClick:se},{default:s(()=>[...e[26]||(e[26]=[_("跳过隐私文档",-1)])]),_:1}),a(n,{type:"primary",onClick:J},{default:s(()=>[...e[27]||(e[27]=[_("确认并恢复",-1)])]),_:1})])]),default:s(()=>[e[28]||(e[28]=y("p",null,"备份中包含隐私文档，需要提供隐私空间密码才能恢复。您也可以选择跳过。",-1)),a(t,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=o=>R.value=o),type:"password",placeholder:"请输入隐私空间密码","show-password":"",onKeyup:q(J,["enter"])},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1})])}}},ge=re(me,[["__scopeId","data-v-e4f2522e"]]);export{ge as default};
