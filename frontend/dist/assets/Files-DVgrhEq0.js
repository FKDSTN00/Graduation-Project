import{O as b,_ as fe,r as d,c as le,o as pe,b as p,e as y,C as te,f as o,w as t,i as m,n as h,p as S,M as me,D as ve,P as c,y as s,F as R,k as ye,t as U,h as u,g as T,ag as _e,K as ke,R as we,E as be,S as ge,N as ae,d as Fe,Q as Ce}from"./index-6DHakvZj.js";function xe(n=null){return b({url:"/files/list",method:"get",params:{parent_id:n}})}function he(n){return b({url:"/files/folders",method:"post",data:n})}function Ve(n){return b({url:"/files/upload",method:"post",data:n,headers:{"Content-Type":"multipart/form-data"}})}function $e(n){return b({url:`/files/files/${n}/preview`,method:"get"})}function Be(n){return b({url:`/files/files/${n}/download`,method:"get"})}function De(n,g){return b({url:`/files/folders/${n}`,method:"put",data:g})}function Me(n,g){return b({url:`/files/files/${n}`,method:"put",data:g})}function Ie(n){return b({url:`/files/folders/${n}`,method:"delete"})}function Re(n){return b({url:`/files/files/${n}`,method:"delete"})}const Ue={class:"toolbar"},Ee={class:"breadcrumbs"},Ne=["onClick"],Pe={class:"right-actions"},Se={class:"file-list-container"},Te={class:"file-name-cell"},ze={class:"preview-container"},Ke={key:1,class:"text-preview"},Le=["src"],He={key:2,class:"pdf-preview"},Ye=["src"],je={key:3,class:"unsupported-preview"},qe={__name:"Files",props:{embedded:{type:Boolean,default:!1}},setup(n){const g=d(!1),E=d(!1),_=d(null),H=d([]),Y=d([]),V=d([]),B=d(!1),z=d(!1),k=d({name:"",url:"",type:""}),K=d(null),N=le(()=>{try{const l=localStorage.getItem("userInfo");return l?JSON.parse(l).role==="admin":!1}catch(l){return console.warn("UserInfo parse check error",l),!1}}),D=d(!1),$=d({name:""}),M=d(!1),v=d({id:null,name:"",type:""}),j=le(()=>{const l=Y.value.map(i=>({...i,isFolder:!0})),e=H.value.map(i=>({...i,isFolder:!1}));return[...l,...e]}),x=async(l=null)=>{var e,i,F,w,r,P;g.value=!0;try{const f=await xe(l);Y.value=f.folders||[],H.value=f.files||[],l===null&&(V.value=[])}catch(f){console.error("加载文件列表失败 - 详细错误:",f),console.error("错误响应:",f.response),console.error("错误数据:",(e=f.response)==null?void 0:e.data),console.error("错误状态:",(i=f.response)==null?void 0:i.status),c.error(`加载失败: ${((w=(F=f.response)==null?void 0:F.data)==null?void 0:w.error)||((P=(r=f.response)==null?void 0:r.data)==null?void 0:P.msg)||f.message||"未知错误"}`)}finally{g.value=!1}},q=l=>{_.value=l.id,V.value.push({id:l.id,name:l.name}),x(l.id)},A=(l,e=-1)=>{_.value=l,l===null?V.value=[]:e!==-1&&(V.value=V.value.slice(0,e+1)),x(l)},oe=l=>{l.isFolder&&q(l)},ne=()=>{$.value.name="",D.value=!0},O=async()=>{if($.value.name)try{await he({name:$.value.name,parent_id:_.value}),c.success("创建成功"),D.value=!1,x(_.value)}catch{c.error("创建失败")}},re=async l=>{const e=new FormData;e.append("file",l.file),_.value&&e.append("parent_id",_.value),E.value=!0;try{await Ve(e),c.success("上传成功"),x(_.value)}catch{c.error("上传失败")}finally{E.value=!1}},se=async l=>{try{const e=await $e(l.id);if(!e.url){c.warning("获取预览链接失败");return}if(k.value={name:l.name,url:e.url,type:l.type},l.type==="docx"){B.value=!0,z.value=!0;try{const i=await fetch(e.url);if(!i.ok)throw new Error("网络请求失败");const w=await(await i.blob()).arrayBuffer();if(await new Promise(r=>setTimeout(r,100)),K.value&&window.docx)await window.docx.renderAsync(w,K.value,null,{className:"docx-wrapper",inWrapper:!0,ignoreWidth:!1,ignoreHeight:!1,ignoreFonts:!1,breakPages:!0,ignoreLastRenderedPageBreak:!0,experimental:!0,trimXmlDeclaration:!0,useBase64URL:!0,renderHeaders:!0,renderFooters:!0,renderFootnotes:!0,renderEndnotes:!0});else throw new Error("docx-preview 库未加载")}catch(i){console.error("渲染 docx 失败:",i),c.error("文档渲染失败，可能是跨域问题，请尝试下载查看"),B.value=!1}finally{z.value=!1}}else["xlsx","pptx","doc","xls","ppt"].includes(l.type)?window.open(e.url,"_blank"):["txt","html","pdf","jpg","jpeg","png","gif"].includes(l.type)?B.value=!0:window.open(e.url,"_blank")}catch(e){console.error("预览失败:",e),c.error("无法预览")}},ie=async l=>{try{const e=await Be(l.id);e.url?window.open(e.url,"_blank"):c.warning("获取下载链接失败")}catch{c.error("无法下载")}},W=l=>{v.value={id:l.id,name:l.name,type:l.isFolder?"folder":"file"},M.value=!0},G=async()=>{if(v.value.name)try{v.value.type==="folder"?await De(v.value.id,{name:v.value.name}):await Me(v.value.id,{name:v.value.name}),c.success("重命名成功"),M.value=!1,x(_.value)}catch{c.error("重命名失败")}},J=l=>{Ce.confirm(`确定删除${l.isFolder?"文件夹":"文件"} "${l.name}" 吗？`,"提示",{type:"warning"}).then(async()=>{try{l.isFolder?await Ie(l.id):await Re(l.id),c.success("删除成功"),x(_.value)}catch{c.error("删除失败")}})},ue=l=>{if(l===0||!l)return"0 B";const e=1024,i=["B","KB","MB","GB","TB"],F=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,F)).toFixed(2))+" "+i[F]},de=l=>l?Fe(l).format("YYYY-MM-DD HH:mm:ss"):"-";return pe(()=>{x(null)}),(l,e)=>{const i=m("el-breadcrumb-item"),F=m("el-breadcrumb"),w=m("el-icon"),r=m("el-button"),P=m("el-upload"),f=m("el-empty"),I=m("el-table-column"),ce=m("el-table"),Q=m("el-input"),X=m("el-form-item"),Z=m("el-form"),L=m("el-dialog"),ee=me("loading");return s(),p("div",{class:ve(["file-center",{"is-embedded":n.embedded}])},[y("div",Ue,[y("div",Ee,[o(F,{separator:"/"},{default:t(()=>[o(i,null,{default:t(()=>[y("a",{onClick:e[0]||(e[0]=a=>A(null)),class:"breadcrumb-link"},"根目录")]),_:1}),(s(!0),p(R,null,ye(V.value,(a,C)=>(s(),h(i,{key:a.id},{default:t(()=>[y("a",{onClick:Ae=>A(a.id,C),class:"breadcrumb-link"},U(a.name),9,Ne)]),_:2},1024))),128))]),_:1})]),y("div",Pe,[N.value?(s(),h(r,{key:0,type:"primary",onClick:ne},{default:t(()=>[o(w,null,{default:t(()=>[o(T(_e))]),_:1}),e[10]||(e[10]=u(" 新建文件夹 ",-1))]),_:1})):S("",!0),N.value?(s(),h(P,{key:1,class:"upload-demo",action:"#","show-file-list":!1,"http-request":re,disabled:E.value,accept:"*"},{default:t(()=>[o(r,{type:"success",loading:E.value},{default:t(()=>[o(w,null,{default:t(()=>[o(T(ke))]),_:1}),e[11]||(e[11]=u(" 上传文件 ",-1))]),_:1},8,["loading"])]),_:1},8,["disabled"])):S("",!0)])]),te((s(),p("div",Se,[!g.value&&j.value.length===0?(s(),h(f,{key:0,description:"暂无文件"})):(s(),h(ce,{key:1,data:j.value,style:{width:"100%"},onRowClick:oe},{default:t(()=>[o(I,{label:"名称","min-width":"250"},{default:t(({row:a})=>[y("div",Te,[a.isFolder?(s(),h(w,{key:0,class:"file-icon folder-icon"},{default:t(()=>[o(T(we))]),_:1})):(s(),h(w,{key:1,class:"file-icon"},{default:t(()=>[o(T(be))]),_:1})),y("span",null,U(a.name),1)])]),_:1}),o(I,{prop:"size",label:"大小",width:"120"},{default:t(({row:a})=>[u(U(ue(a.size)),1)]),_:1}),o(I,{prop:"created_at",label:"创建时间",width:"180"},{default:t(({row:a})=>[u(U(de(a.created_at)),1)]),_:1}),o(I,{prop:"creator",label:"创建者/上传者",width:"150"},{default:t(({row:a})=>[u(U(a.creator||a.uploader),1)]),_:1}),o(I,{label:"操作",width:"220",fixed:"right"},{default:t(({row:a})=>[y("div",{class:"actions",onClick:e[1]||(e[1]=ge(()=>{},["stop"]))},[a.isFolder?(s(),p(R,{key:0},[o(r,{link:"",type:"primary",onClick:C=>q(a)},{default:t(()=>[...e[12]||(e[12]=[u("打开",-1)])]),_:1},8,["onClick"]),N.value?(s(),p(R,{key:0},[o(r,{link:"",type:"warning",onClick:C=>W(a)},{default:t(()=>[...e[13]||(e[13]=[u("重命名",-1)])]),_:1},8,["onClick"]),o(r,{link:"",type:"danger",onClick:C=>J(a)},{default:t(()=>[...e[14]||(e[14]=[u("删除",-1)])]),_:1},8,["onClick"])],64)):S("",!0)],64)):(s(),p(R,{key:1},[o(r,{link:"",type:"primary",onClick:C=>se(a)},{default:t(()=>[...e[15]||(e[15]=[u("预览",-1)])]),_:1},8,["onClick"]),o(r,{link:"",type:"primary",onClick:C=>ie(a)},{default:t(()=>[...e[16]||(e[16]=[u("下载",-1)])]),_:1},8,["onClick"]),N.value?(s(),p(R,{key:0},[o(r,{link:"",type:"warning",onClick:C=>W(a)},{default:t(()=>[...e[17]||(e[17]=[u("重命名",-1)])]),_:1},8,["onClick"]),o(r,{link:"",type:"danger",onClick:C=>J(a)},{default:t(()=>[...e[18]||(e[18]=[u("删除",-1)])]),_:1},8,["onClick"])],64)):S("",!0)],64))])]),_:1})]),_:1},8,["data"]))])),[[ee,g.value]]),o(L,{modelValue:D.value,"onUpdate:modelValue":e[4]||(e[4]=a=>D.value=a),title:"新建文件夹",width:"400px"},{footer:t(()=>[o(r,{onClick:e[3]||(e[3]=a=>D.value=!1)},{default:t(()=>[...e[19]||(e[19]=[u("取消",-1)])]),_:1}),o(r,{type:"primary",onClick:O},{default:t(()=>[...e[20]||(e[20]=[u("确定",-1)])]),_:1})]),default:t(()=>[o(Z,{model:$.value},{default:t(()=>[o(X,{label:"文件夹名称"},{default:t(()=>[o(Q,{modelValue:$.value.name,"onUpdate:modelValue":e[2]||(e[2]=a=>$.value.name=a),placeholder:"请输入名称",onKeyup:ae(O,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(L,{modelValue:M.value,"onUpdate:modelValue":e[7]||(e[7]=a=>M.value=a),title:"重命名",width:"400px"},{footer:t(()=>[o(r,{onClick:e[6]||(e[6]=a=>M.value=!1)},{default:t(()=>[...e[21]||(e[21]=[u("取消",-1)])]),_:1}),o(r,{type:"primary",onClick:G},{default:t(()=>[...e[22]||(e[22]=[u("确定",-1)])]),_:1})]),default:t(()=>[o(Z,{model:v.value},{default:t(()=>[o(X,{label:"新名称"},{default:t(()=>[o(Q,{modelValue:v.value.name,"onUpdate:modelValue":e[5]||(e[5]=a=>v.value.name=a),placeholder:"请输入新名称",onKeyup:ae(G,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(L,{modelValue:B.value,"onUpdate:modelValue":e[9]||(e[9]=a=>B.value=a),title:k.value.name,width:"80%","close-on-click-modal":!1,"destroy-on-close":""},{default:t(()=>[te((s(),p("div",ze,[k.value.type==="docx"?(s(),p("div",{key:0,ref_key:"docxPreviewRef",ref:K,class:"docx-preview"},null,512)):k.value.type==="txt"||k.value.type==="html"?(s(),p("div",Ke,[y("iframe",{src:k.value.url,frameborder:"0",style:{width:"100%",height:"600px"}},null,8,Le)])):k.value.type==="pdf"?(s(),p("div",He,[y("iframe",{src:k.value.url,frameborder:"0",style:{width:"100%",height:"600px"}},null,8,Ye)])):(s(),p("div",je,[o(f,{description:"此文件类型暂不支持在线预览"},{default:t(()=>[o(r,{type:"primary",onClick:e[8]||(e[8]=a=>l.window.open(k.value.url,"_blank"))},{default:t(()=>[...e[23]||(e[23]=[u("在新窗口打开",-1)])]),_:1})]),_:1})]))])),[[ee,z.value]])]),_:1},8,["modelValue","title"])],2)}}},We=fe(qe,[["__scopeId","data-v-33781fc0"]]);export{We as default};
