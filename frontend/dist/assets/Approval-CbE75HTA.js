import{O as M,_ as fe,d as ee,Y as ge,u as ye,r as g,c as ae,Z as he,o as be,b as m,e as s,C as ke,f as t,n as y,p as _,g as W,w as l,h as u,H as Ve,i as p,M as we,F as R,k as te,t as r,S as Te,P as h,Q as le,y as d}from"./index-6DHakvZj.js";function Ce(O){return M({url:"/approval/",method:"post",data:O})}function Ae(){return M({url:"/approval/",method:"get"})}function xe(O,C){return M({url:`/approval/${O}/status`,method:"put",data:{action:C}})}function De(){return M({url:"/approval/processed",method:"delete"})}const Ue={class:"approval-container"},Re={class:"header-section"},Me={class:"list-container"},Oe={class:"collapse-title"},$e={key:0,class:"empty-state"},Be={key:1,class:"grid-layout"},We={class:"card-header-custom"},Ye={class:"user-info"},qe={class:"meta"},ze={class:"username"},Se={class:"email"},He={class:"card-body"},Ne={class:"info-row"},je={class:"value"},Ee={class:"info-row"},Ie={class:"value"},Pe={class:"collapse-header-wrapper"},Fe={class:"collapse-title"},Le={key:0,class:"empty-state"},Qe={key:1,class:"grid-layout"},Ze={class:"card-header-custom"},Ge={class:"user-info"},Je={class:"meta"},Ke={class:"username"},Xe={class:"email"},ea={class:"card-body"},aa={class:"info-row"},ta={class:"value"},la={class:"info-row"},sa={class:"value"},oa={key:0,class:"detail-content"},na={class:"detail-header"},ra={class:"detail-user-info"},ia={class:"detail-status"},da={key:0,class:"dialog-actions"},I="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",ua={__name:"Approval",setup(O){ee.extend(ge);const C=ye(),Y=g(!1),P=g(["pending"]),q=g([]),z=ae(()=>q.value.filter(o=>o.status==="pending")),$=ae(()=>q.value.filter(o=>o.status!=="pending")),A=g(!1),x=g(!1),i=g(null),S=g(!1),F=g(null),n=he({type:"",reason:"",timeRange:[],originalWorkTime:"",desiredTimeOff:"",duration:""}),se={type:[{required:!0,message:"请选择申请类别",trigger:"change"}],reason:[{required:!0,message:"请输入申请理由",trigger:"blur"}],timeRange:[{required:!0,message:"请选择时间范围",trigger:"change"}],originalWorkTime:[{required:!0,message:"请输入原本工作时间",trigger:"blur"}],desiredTimeOff:[{required:!0,message:"请输入想调到什么时候",trigger:"blur"}],duration:[{required:!0,message:"请输入预支工期",trigger:"blur"}]},L=()=>{n.reason="",n.timeRange=[],n.originalWorkTime="",n.desiredTimeOff="",n.duration=""},oe=()=>{n.type="",L(),A.value=!0},ne=async()=>{n.type&&await F.value.validate(async(o,e)=>{var b,c;if(o){S.value=!0;try{const v={type:n.type,details:{reason:n.reason,timeRange:n.timeRange,originalWorkTime:n.originalWorkTime,desiredTimeOff:n.desiredTimeOff,duration:n.duration}};await Ce(v),h.success("申请已提交"),A.value=!1,D()}catch(v){console.error(v),h.error(((c=(b=v.response)==null?void 0:b.data)==null?void 0:c.msg)||"提交失败")}finally{S.value=!1}}else console.warn("Form validation failed",e),h.warning("请检查输入项是否完整")})},D=async()=>{Y.value=!0;try{const o=await Ae();q.value=o.data||o}catch(o){console.error(o)}finally{Y.value=!1}},Q=o=>{i.value=o,x.value=!0},Z=async(o,e)=>{var b;if(((b=i.value)==null?void 0:b.type)==="password_reset"&&e==="approve"){le.prompt("请输入为用户重置的新密码","重置密码",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^.{6,}$/,inputErrorMessage:"密码长度至少6位",inputType:"text"}).then(async({value:c})=>{var v,V;try{await M.put(`/approval/${o}/status`,{action:e,new_password:c}),h.success("已重置密码并发送邮件"),x.value=!1,D()}catch(w){console.error(w),h.error(((V=(v=w.response)==null?void 0:v.data)==null?void 0:V.msg)||"操作失败")}}).catch(()=>{});return}try{await xe(o,e),h.success(e==="approve"?"已同意该申请":"已拒绝该申请"),x.value=!1,D()}catch(c){console.error(c)}},re=()=>{le.confirm("确定要清空所有已处理（已通过/已拒绝）的申请记录吗？此操作不可恢复。","清空确认",{confirmButtonText:"确定清空",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await De(),h.success("已清空所有已处理记录"),D()}catch(o){console.error(o),h.error("清空失败")}}).catch(()=>{})},H=o=>({pending:"待审批",approved:"已通过",rejected:"已拒绝"})[o]||o,N=o=>({pending:"warning",approved:"success",rejected:"danger"})[o]||"info",j=o=>({intern_conversion:"实习生转正",leave:"请假",time_off:"调休",business_trip:"出差",salary_advance:"工资预支",password_reset:"重置密码"})[o]||o,E=o=>ee(o).format("YYYY-MM-DD HH:mm"),ie=o=>Array.isArray(o)&&o.length===2?`${o[0]} 至 ${o[1]}`:"未指定";return be(()=>{D()}),(o,e)=>{var X;const b=p("el-icon"),c=p("el-button"),v=p("el-empty"),V=p("el-avatar"),w=p("el-tag"),G=p("el-card"),J=p("el-collapse-item"),de=p("el-collapse"),U=p("el-option"),ue=p("el-select"),T=p("el-form-item"),B=p("el-input"),pe=p("el-date-picker"),ce=p("el-form"),K=p("el-dialog"),k=p("el-descriptions-item"),me=p("el-descriptions"),_e=we("loading");return d(),m("div",Ue,[s("div",Re,[e[13]||(e[13]=s("div",{class:"title-group"},[s("h2",null,"审批流程"),s("p",{class:"subtitle"},"管理和查看所有的审批申请")],-1)),((X=W(C).userInfo)==null?void 0:X.role)==="user"?(d(),y(c,{key:0,type:"primary",class:"create-btn",onClick:oe},{default:l(()=>[t(b,{class:"mr-1"},{default:l(()=>[t(W(Ve))]),_:1}),e[12]||(e[12]=u(" 发起申请 ",-1))]),_:1})):_("",!0)]),ke((d(),m("div",Me,[t(de,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=a=>P.value=a)},{default:l(()=>[t(J,{title:"未处理",name:"pending"},{title:l(()=>[s("span",Oe,"未处理 ("+r(z.value.length)+")",1)]),default:l(()=>[z.value.length===0?(d(),m("div",$e,[t(v,{description:"暂无未处理申请","image-size":80})])):(d(),m("div",Be,[(d(!0),m(R,null,te(z.value,a=>(d(),y(G,{key:a.id,class:"approval-card",shadow:"hover",onClick:f=>Q(a)},{default:l(()=>[s("div",We,[s("div",Ye,[t(V,{src:a.applicant.avatar||I,size:40},{default:l(()=>{var f;return[u(r((f=a.applicant.username)==null?void 0:f.charAt(0).toUpperCase()),1)]}),_:2},1032,["src"]),s("div",qe,[s("span",ze,r(a.applicant.username),1),s("span",Se,r(a.applicant.email),1)])]),t(w,{type:N(a.status),effect:"dark",class:"status-tag"},{default:l(()=>[u(r(H(a.status)),1)]),_:2},1032,["type"])]),s("div",He,[s("div",Ne,[e[14]||(e[14]=s("span",{class:"label"},"申请类别:",-1)),s("span",je,r(j(a.type)),1)]),s("div",Ee,[e[15]||(e[15]=s("span",{class:"label"},"提交时间:",-1)),s("span",Ie,r(E(a.created_at)),1)])])]),_:2},1032,["onClick"]))),128))]))]),_:1}),t(J,{title:"已处理",name:"processed"},{title:l(()=>{var a;return[s("div",Pe,[s("span",Fe,"已处理 ("+r($.value.length)+")",1),((a=W(C).userInfo)==null?void 0:a.role)==="admin"&&$.value.length>0?(d(),y(c,{key:0,type:"danger",link:"",size:"small",onClick:Te(re,["stop"])},{default:l(()=>[...e[16]||(e[16]=[u(" 清空记录 ",-1)])]),_:1})):_("",!0)])]}),default:l(()=>[$.value.length===0?(d(),m("div",Le,[t(v,{description:"暂无已处理申请","image-size":80})])):(d(),m("div",Qe,[(d(!0),m(R,null,te($.value,a=>(d(),y(G,{key:a.id,class:"approval-card",shadow:"hover",onClick:f=>Q(a)},{default:l(()=>[s("div",Ze,[s("div",Ge,[t(V,{src:a.applicant.avatar||I,size:40},{default:l(()=>{var f;return[u(r((f=a.applicant.username)==null?void 0:f.charAt(0).toUpperCase()),1)]}),_:2},1032,["src"]),s("div",Je,[s("span",Ke,r(a.applicant.username),1),s("span",Xe,r(a.applicant.email),1)])]),t(w,{type:N(a.status),effect:"dark",class:"status-tag"},{default:l(()=>[u(r(H(a.status)),1)]),_:2},1032,["type"])]),s("div",ea,[s("div",aa,[e[17]||(e[17]=s("span",{class:"label"},"申请类别:",-1)),s("span",ta,r(j(a.type)),1)]),s("div",la,[e[18]||(e[18]=s("span",{class:"label"},"提交时间:",-1)),s("span",sa,r(E(a.created_at)),1)])])]),_:2},1032,["onClick"]))),128))]))]),_:1})]),_:1},8,["modelValue"])])),[[_e,Y.value]]),t(K,{modelValue:A.value,"onUpdate:modelValue":e[8]||(e[8]=a=>A.value=a),title:"发起审批申请",width:"550px","destroy-on-close":"",class:"custom-dialog"},{footer:l(()=>[t(c,{onClick:e[7]||(e[7]=a=>A.value=!1)},{default:l(()=>[...e[19]||(e[19]=[u("取消",-1)])]),_:1}),t(c,{type:"primary",loading:S.value,onClick:ne},{default:l(()=>[...e[20]||(e[20]=[u("提交申请",-1)])]),_:1},8,["loading"])]),default:l(()=>[t(ce,{ref_key:"formRef",ref:F,model:n,rules:se,"label-width":"100px","label-position":"top"},{default:l(()=>[t(T,{label:"申请类别",prop:"type"},{default:l(()=>[t(ue,{modelValue:n.type,"onUpdate:modelValue":e[1]||(e[1]=a=>n.type=a),placeholder:"请选择申请类别",style:{width:"100%"},onChange:L},{default:l(()=>[t(U,{label:"实习生转正",value:"intern_conversion"}),t(U,{label:"请假",value:"leave"}),t(U,{label:"调休",value:"time_off"}),t(U,{label:"出差",value:"business_trip"}),t(U,{label:"工资预支",value:"salary_advance"})]),_:1},8,["modelValue"])]),_:1}),n.type?(d(),m(R,{key:0},[t(T,{label:"申请理由",prop:"reason"},{default:l(()=>[t(B,{type:"textarea",rows:3,modelValue:n.reason,"onUpdate:modelValue":e[2]||(e[2]=a=>n.reason=a),placeholder:"请输入申请理由"},null,8,["modelValue"])]),_:1}),n.type==="leave"?(d(),y(T,{key:0,label:"申请时间",prop:"timeRange"},{default:l(()=>[t(pe,{modelValue:n.timeRange,"onUpdate:modelValue":e[3]||(e[3]=a=>n.timeRange=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})):_("",!0),n.type==="time_off"?(d(),m(R,{key:1},[t(T,{label:"原本工作时间",prop:"originalWorkTime"},{default:l(()=>[t(B,{modelValue:n.originalWorkTime,"onUpdate:modelValue":e[4]||(e[4]=a=>n.originalWorkTime=a),placeholder:"例如：本周六"},null,8,["modelValue"])]),_:1}),t(T,{label:"想调到何时",prop:"desiredTimeOff"},{default:l(()=>[t(B,{modelValue:n.desiredTimeOff,"onUpdate:modelValue":e[5]||(e[5]=a=>n.desiredTimeOff=a),placeholder:"例如：下周一"},null,8,["modelValue"])]),_:1})],64)):_("",!0),n.type==="salary_advance"?(d(),y(T,{key:2,label:"预支工期",prop:"duration"},{default:l(()=>[t(B,{modelValue:n.duration,"onUpdate:modelValue":e[6]||(e[6]=a=>n.duration=a),placeholder:"例如：1个月"},null,8,["modelValue"])]),_:1})):_("",!0)],64)):_("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(K,{modelValue:x.value,"onUpdate:modelValue":e[11]||(e[11]=a=>x.value=a),title:"申请详情",width:"600px",class:"custom-dialog"},{footer:l(()=>{var a,f;return[((a=W(C).userInfo)==null?void 0:a.role)==="admin"&&((f=i.value)==null?void 0:f.status)==="pending"?(d(),m("div",da,[t(c,{type:"danger",onClick:e[9]||(e[9]=ve=>Z(i.value.id,"reject"))},{default:l(()=>[...e[21]||(e[21]=[u("拒绝",-1)])]),_:1}),t(c,{type:"success",onClick:e[10]||(e[10]=ve=>Z(i.value.id,"approve"))},{default:l(()=>[...e[22]||(e[22]=[u("同意",-1)])]),_:1})])):_("",!0)]}),default:l(()=>[i.value?(d(),m("div",oa,[s("div",na,[t(V,{src:i.value.applicant.avatar||I,size:60},{default:l(()=>{var a;return[u(r((a=i.value.applicant.username)==null?void 0:a.charAt(0).toUpperCase()),1)]}),_:1},8,["src"]),s("div",ra,[s("h3",null,r(i.value.applicant.username),1),s("p",null,r(i.value.applicant.email),1)]),s("div",ia,[t(w,{type:N(i.value.status),size:"large",effect:"dark"},{default:l(()=>[u(r(H(i.value.status)),1)]),_:1},8,["type"])])]),t(me,{column:1,border:"",class:"mt-4"},{default:l(()=>[t(k,{label:"申请类别"},{default:l(()=>[u(r(j(i.value.type)),1)]),_:1}),t(k,{label:"申请理由"},{default:l(()=>[u(r(i.value.details.reason),1)]),_:1}),i.value.type==="leave"?(d(),y(k,{key:0,label:"时间范围"},{default:l(()=>[u(r(ie(i.value.details.timeRange)),1)]),_:1})):_("",!0),i.value.type==="time_off"?(d(),m(R,{key:1},[t(k,{label:"原工作时间"},{default:l(()=>[u(r(i.value.details.originalWorkTime),1)]),_:1}),t(k,{label:"期望调休时间"},{default:l(()=>[u(r(i.value.details.desiredTimeOff),1)]),_:1})],64)):_("",!0),i.value.type==="salary_advance"?(d(),y(k,{key:2,label:"预支工期"},{default:l(()=>[u(r(i.value.details.duration),1)]),_:1})):_("",!0),t(k,{label:"申请时间"},{default:l(()=>[u(r(E(i.value.created_at)),1)]),_:1})]),_:1})])):_("",!0)]),_:1},8,["modelValue"])])}}},ca=fe(ua,[["__scopeId","data-v-575f027d"]]);export{ca as default};
