import{_ as L,z as U,r as _,o as P,A as j,P as c,x as z,B as M,O as y,b as D,e as I,f as d,w as u,h as F,i as g,n as N,p as H,g as O,F as $,k as A,y as x}from"./index-6DHakvZj.js";const K={class:"document-editor"},Q={class:"editor-header"},G={class:"editor-content"},J={__name:"DocumentEditor",setup(W){const E=z(),i=j(),h=U(),a=_({title:"",content:"",folder_id:null,attachments:[]}),w=_([]);let m=null;const V=_([]),q=_(!1),b=_(null),C=_(!1);P(async()=>{if(window.wangEditor){const{createEditor:o,createToolbar:e}=window.wangEditor,t={placeholder:"请输入文档内容...",onChange(r){a.value.content=r.getHtml()},MENU_CONF:{uploadImage:{async customUpload(r,p){var n,k;const s=new FormData;s.append("file",r);try{const v=await y.post("/docs/attachments",s,{headers:{"Content-Type":"multipart/form-data"}});p(v.url,r.name,v.url),w.value.push(v.url),c.success("图片上传成功")}catch(v){c.error("图片上传失败："+(((k=(n=v.response)==null?void 0:n.data)==null?void 0:k.msg)||v.message))}}}}},l=o({selector:"#editor-container",html:a.value.content,config:t,mode:"default"});e({editor:l,selector:"#toolbar-container",config:{toolbarKeys:["headerSelect","bold","italic","underline","through","|","bulletedList","numberedList","|","color","bgColor","|","fontSize","fontFamily","|","justifyLeft","justifyCenter","justifyRight","|","insertLink","uploadImage","insertTable","|","codeBlock","blockquote","|","undo","redo","clearStyle"]},mode:"default"}),m=l}if(await R(),i.query.privacy==="true"&&(C.value=!0,!h.accessToken||h.needsReauth())){c.error("请先进入隐私空间"),E.push("/documents");return}if(i.params.id)b.value=i.params.id,await S();else if(i.query.folderId)a.value.folder_id=parseInt(i.query.folderId);else{const o=V.value.find(e=>e.name==="未分组");o&&(a.value.folder_id=o.id)}}),M(()=>{m&&(m.destroy(),m=null)});const R=async()=>{try{const o=await y.get("/docs/folders");V.value=o}catch(o){console.error("获取文件夹失败:",o)}},S=async()=>{var o,e;try{const t={};h.password&&(t._privacy_password=h.password);const l=await y.get(`/docs/${b.value}`,{params:t});if(a.value.title=l.title,a.value.content=l.content,a.value.folder_id=l.folder_id,C.value=l.in_privacy_space,a.value.attachments=l.attachments||[],m&&l.content&&m.setHtml(l.content),l.content){const f=/<img[^>]+src="([^">]+)"/g;let r;for(;(r=f.exec(l.content))!==null;)r[1]&&!w.value.includes(r[1])&&w.value.push(r[1])}}catch(t){console.error("获取文档失败:",t),c.error(((e=(o=t.response)==null?void 0:o.data)==null?void 0:e.msg)||"获取文档失败")}},T=async()=>{var o,e;if(!a.value.title){c.warning("请输入文档标题");return}q.value=!0;try{const t=a.value.content||"",l=[],f=/<img[^>]+src="([^">]+)"/g;let r;for(;(r=f.exec(t))!==null;)r[1]&&l.push(r[1]);const p=w.value.filter(n=>!l.includes(n));p.length>0&&Promise.all(p.map(n=>y.delete("/docs/attachments",{data:{url:n}}).catch(k=>console.error("清理图片失败:",k))));const s={...a.value};if(s.attachments=a.value.attachments||[],(C.value||i.query.privacy==="true")&&(s.in_privacy_space=!0,s._privacy_password=h.password,!s._privacy_password)){c.error("隐私空间密码不可用，请重新进入隐私空间"),B();return}b.value?(await y.put(`/docs/${b.value}`,s),c.success("文档更新成功")):(await y.post("/docs/",s),c.success("文档创建成功")),B()}catch(t){console.error("保存文档失败:",t),c.error(((e=(o=t.response)==null?void 0:o.data)==null?void 0:e.msg)||"保存文档失败")}finally{q.value=!1}},B=()=>{const{view:o,folderId:e}=i.query,t={};o&&(t.view=o),e&&(t.folderId=e),E.push({path:"/documents",query:t})};return(o,e)=>{const t=g("el-button"),l=g("el-option"),f=g("el-select"),r=g("el-form-item"),p=g("el-input"),s=g("el-form");return x(),D("div",K,[I("div",Q,[d(t,{onClick:B},{default:u(()=>[...e[2]||(e[2]=[F("返回列表",-1)])]),_:1}),d(t,{type:"primary",onClick:T,loading:q.value},{default:u(()=>[...e[3]||(e[3]=[F("保存",-1)])]),_:1},8,["loading"])]),I("div",G,[d(s,{model:a.value,"label-width":"80px"},{default:u(()=>[!C.value&&O(i).query.privacy!=="true"?(x(),N(r,{key:0,label:"文件夹"},{default:u(()=>[d(f,{modelValue:a.value.folder_id,"onUpdate:modelValue":e[0]||(e[0]=n=>a.value.folder_id=n),placeholder:"选择文件夹",style:{width:"100%"}},{default:u(()=>[(x(!0),D($,null,A(V.value,n=>(x(),N(l,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):H("",!0),d(r,{label:"标题"},{default:u(()=>[d(p,{modelValue:a.value.title,"onUpdate:modelValue":e[1]||(e[1]=n=>a.value.title=n),placeholder:"请输入文档标题",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),d(r,{label:"内容",class:"editor-item"},{default:u(()=>[...e[4]||(e[4]=[I("div",{id:"toolbar-container"},null,-1),I("div",{id:"editor-container"},null,-1)])]),_:1})]),_:1},8,["model"])])])}}},Y=L(J,[["__scopeId","data-v-3ed31ead"]]);export{Y as default};
